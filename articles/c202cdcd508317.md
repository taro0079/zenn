---
title: "SymfonyでObserverパターンを実装する"
emoji: "💨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ['php', 'symfony', 'design-pattern']
published: false
---

# Observerパターンとは
Observerパターンは、オブジェクトの状態が変化したときに、そのオブジェクトに依存している他のオブジェクトに通知を送るためのデザインパターンです。
例えば、「受注が登録されたときにメールを送る、ログを出力する」といった場合を考えてみます。
Observerパターンを利用しない場合、以下のような実装になるでしょう。
```php
class PurchaseFromFoo
{
    public function __construct(
        private RegisterOrderService $registerOrderService,
        private SendMailService $sendMailService,
        private LogService $logService,
        ){
    }

    public function register()
    {
        // 受注を登録するときにはメールを送る、ログを出力する
        $this->registerOrderService->execute();
        $this->sendMailService->sendMail();
        $this->logService->createLog();
    }
}

```
この場合は、受注を登録する、メールを送る、ログを出力する処理がPurchaseFromFooにまとまってしまっており、これらのロジックは互いに密結合しています。
新しく処理を追加する場合には、PurchaseFromFooクラスを修正し、新しいクラスに依存を追加する必要があります。
Observerパターンを利用することで、このような問題を解決することができます。
```php
<?php

interface Observer {
    public function update($temperature);
}

class PurchaseFromFoo {

    /**
     * @var Observer[]
     */
    private array $observers = [];

    public function addObserver(Observer $observer) {
        $this->observers[] = $observer;
    }

    public function removeObserver(Observer $observer) {
        $this->observers = array_filter($this->observers, fn($o) => $o !== $observer);
    }

    public function register(Order $order) {
        $this->notify($order);
    }

    private function notify(Order $order) {
        foreach ($this->observers as $observer) {
            $observer->update($order);
        }
    }
}

class SendEmail implements Observer {
    public function onPlaced(Order $order) {
        $this->sendEmailLogic();
    }
}

class WriteLog implements Observer {
    public function onPlaced(Order $order) {
        $this->someLogLogic();
    }
}

// 利用例
$purchaseFromFoo = new PurchaseFromFoo();

$sendEmail = new SendEmail();
$writeLog = new WriteLog();

// observerを登録
$purchaseFromFoo.addObserver($sendEmail);
$purchaseFromFoo.addObserver($writeLog);

// 受注登録
$order = new Order();
$purchaseFromFoo->register($order);
```

このように、Observerパターンを利用することで、ロジックを疎結合にすることができます。

# SymfonyでObserverパターンを実装する
SymfonyでObserverパターンを実装する場合、自前でObserverを実装する必要はありません。
EventDispatcherを利用することができます。


