---
title: "Arduinoã§æ¸©åº¦ã‚’è¨ˆæ¸¬ & chart.jsã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Arduino", "python", "websocket", "javascript"]
published: true
---

åˆæŠ•ç¨¿ã§ã™ã€‚
Arduino ã§æ¸©åº¦è¨ˆæ¸¬ã—ã€å–å¾—ã—ãŸæ¸©åº¦ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ—ãƒ­ãƒƒãƒˆã§ãã‚‹ã‚ˆã†ãªã‚‚ã®ã‚’ä½œã‚Šã¾ã™ã€‚

# Requirements

- Arduino
- ã‚µãƒ¼ãƒŸã‚¹ã‚¿ (MCP9700/9700A) : ç§‹æœˆé›»å­ã§è³¼å…¥ã—ã¾ã—ãŸã€‚
- 1 $\mu$F ã®ã‚³ãƒ³ãƒ‡ãƒ³ã‚µ
- ãƒ–ãƒ¬ãƒƒãƒ‰ãƒœãƒ¼ãƒ‰

# Arduino ã®è¨­å®š

## ã‚µãƒ¼ãƒŸã‚¹ã‚¿ã¨ Arduino ã‚’æ¥ç¶šã™ã‚‹

![Arduinoã¨ã‚µãƒ¼ãƒŸã‚¹ã‚¿ã®æ¥ç¶š](/images/arduino_temp.png)

1. arduinoã€ã‚³ãƒ³ãƒ‡ãƒ³ã‚µã€ã‚µãƒ¼ãƒŸã‚¹ã‚¿ã‚’å›³ã®ã‚ˆã†ã«æ¥ç¶šã—ã¾ã™ã€‚
2. Arduino ã‚’ PC ã¨æ¥ç¶šã—ã€Arduino IDE ã§æ¬¡ã®ã‚ˆã†ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ Arduino ã«æ›¸ãè¾¼ã¿ã¾ã™ã€‚

```arduino
const int vOutPin = 0;
void setup() {
    Serial.begin(57600);
    analogReference(EXTERNAL);
}

void loop() {
    int reading = analogRead(vOutPin);
    float voltage = ((long)reading * 3000) / 1024;

    float temp = (voltage - 500) / 10;
    Serial.print(temp);

    delay(1000);
}
```

ã“ã‚Œã§ Arduino ã‹ã‚‰ã‚µãƒ¼ãƒŸã‚¹ã‚¿ã§èª­ã¿å–ã£ãŸæ¸©åº¦ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

# ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ä½œæˆ

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

ä½œæˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã™ã¹ã¦åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å…¥ã‚Œã¦ OK ã§ã™ã€‚

```
temp_reading
â”œ reading_temperautre.py
â”œ websocket_server.py
â”” monitor.html
```

## Arduino ã‹ã‚‰å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ¸©åº¦ã‚’èª­ã¿å–ã‚‹

python ã® pyserial ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã—ã¦ arduino ã®ã‚·ãƒªã‚¢ãƒ«å‡ºåŠ›ã‚’èª­ã¿å–ã‚Šã¾ã™ã€‚
ã¾ãšã¯ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§ pyserial ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```shell
pip3 install pyserial
```

ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ python ã§æ¸©åº¦ã‚’èª­ã¿å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```python:reading_temperature.py
import serial # serialé€šä¿¡ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
import time
import re # æ­£è¦è¡¨ç¾ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

def read_temperature() -> float:
  ser = serial.Serial("COM5", 57600)
  pattern = '\d'
  result = ser.readline().decode()
  matched = re.findall(pattern, result)
  if len(matched) > 0:
    temperature = matched[0]
  else:
    temperature = 0

  return float(temperature)
```

## Python ã§ websocket ã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã™ã‚‹

æ¬¡ã« websocket ã®ã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
ã¾ãšã¯ tornado ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```shell
pip3 install tornado
```

ä»¥ä¸‹ã®ã‚ˆã†ã« websocket server ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```python:webscoket_server.py

import json
import time

import tornado.websocket
import tornado.web
import tornado.ioloop

from reading_temperature import read_temperature # å…ˆã»ã©ä½œæˆã—ãŸæ¸©åº¦èª­ã¿å–ã‚Šãƒ—ãƒ­ã‚°ãƒ©ãƒ 

class SendWebSocket(tornado.websocket.WebSocketHandler):
  def open(self):
    print('Session Opened. IP:' + self.request.remote_ip)
    self.ioloop = tornado.ioloop.IOLoop.instance()
    self.send_websocket()

  def on_close(self):
    print("Session Closed")

  def check_origin(self, origin):
    return True

  def send_websocket(self):
    self.ioloop.add_timeout(time.time() + 0.1, self.send_websocket)
    if self.ws_connection:
      message = json.dumps({
        'data': read_temperature(), # ã“ã“ã§arduinoã§èª­ã¿å–ã£ãŸæ¸©åº¦ã‚’websocketã§é€ã£ã¦ã„ã‚‹ã€‚
      })
      self.write_message(message)
app = tornado.web.Application([(r"/ws/display", SendWebSocket)])

if __name__ == "__main__":
  app.listen(8080)
  tornado.ioloop.IOLoop.current().start()
```

## ãƒ–ãƒ©ã‚¦ã‚¶ã§æ¸©åº¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹

arduino ã§å–å¾—ã—ãŸæ¸©åº¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ã‚°ãƒ©ãƒ•ãƒ—ãƒ­ãƒƒãƒˆã—ã¾ã™ã€‚
ã‚°ãƒ©ãƒ•ã®ãƒ—ãƒ­ãƒƒãƒˆã«ã¯[Chart.js](https://www.chartjs.org/)ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚
ã¾ãŸã€chart.js ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ­ãƒƒãƒˆã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«[chartjs-plugin-streaming](https://nagix.github.io/chartjs-plugin-streaming/latest/ja/)ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚ï¼ˆè‹¥å¹²ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ã®ãŸã‚ã« Bootstrap ã‚‚ä½¿ã£ã¦ã„ã¾ã™ã€‚ï¼‰

```html:monitor.html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="container-md p-5">
      <h1>Temperature Monitor</h1>
      <div class="text-center p-4">
        <h2 id="Temperature">initializing ...</h2>
      </div>
      <canvas id="myChart"></canvas>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.3.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@1.27.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0"></script>

    <script>
      var ctx = document.getElementById("myChart").getContext("2d");
      var chart = new Chart(ctx, {
        type: "line",
        data: {
          datasets: [
            {
              data: [],
            },
          ],
        },
        options: {
          plugins: {
            streaming: {
              duration: 20000,
            },
          },
          scales: {
            x: {
              type: "realtime",
              realtime: {
                duration: 20000,
              },
            },
          },
        },
      });

      /*  ä»¥ä¸‹ã§webscoketã§å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã‚’è¡Œã£ã¦ã„ã‚‹       */
      var connection = new WebSocket("ws://localhost:8080/ws/display");
      connection.onmessage = function (e) {
        /* æ¸©åº¦ã‚’æ–‡å­—ã§è¡¨ç¤º */
        document.getElementById("Temperature").innerHTML =
          JSON.parse(e.data)["data"] + " degree";

        /* æ¸©åº¦ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ©ãƒ•ã«è¿½åŠ  */
        chart.data.datasets[0].data.push({
          x: Date.now(),
          y: JSON.parse(e.data)["data"],
        });
        chart.update();
      };
    </script>
  </body>
</html>
```

# å®Œæˆã¨ä»Šå¾Œ

`python3 websocket_server.py`ã¨ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«æ‰“ã¡è¾¼ã‚“ã å¾Œã«`monitor.html`ã‚’ web ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã¨æ¸©åº¦è¨ˆæ¸¬ãƒ»ãƒ—ãƒ­ãƒƒãƒˆãŒé–‹å§‹ã—ã¾ã™ã€‚
![å®Œæˆ](/images/browser.png)
å¿…è¦æœ€ä½é™ã®æ§‹æˆã§ã™ãŒã€ã¨ã‚Šã‚ãˆãšå®Œæˆã§ã™ã€‚
ãŸã ã€ä»Šã®ã¾ã¾ã ã¨ html ã‚’é–‹ã„ãŸç¬é–“ã« WebSocket ãŒé–‹ã„ã¦æ¸¬å®šãŒå§‹ã¾ã‚Šã¾ã™ã®ã§ã€ã€Œæ¸¬å®šé–‹å§‹ã€ã€Œæ¸¬å®šä¸­æ­¢ã€ãƒœã‚¿ãƒ³ã‚’ä½œã£ã¦æ¸¬å®šã® ONã€OFF ã‚’å®Ÿè£…å‡ºæ¥ãŸã‚‰ã„ã„ãªã‚ã¨æ€ã£ã¦ã¾ã™ã€‚
å¤§å­¦é™¢ã®ã“ã‚ã«å®Ÿé¨“ã®æ¸¬å®šãƒ»åˆ¶å¾¡ã¨ãªã‚‹ã¨é«˜ä¾¡ãª Labview ä½¿ã†ã—ã‹ãªãå›°ã£ã¦ã„ã¾ã—ãŸãŒã€æœ¬æ‰‹æ³•ã‚’ä½¿ã†ã“ã¨ã§æ‰‹è»½ã«å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤ºã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
é«˜æ©Ÿèƒ½ãª Labview ã®ä»£æ›¿ã¾ã§ã¨ã¯ã„ãã¾ã›ã‚“ãŒã€ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹ã ã‘ã§ã‚ã‚Œã°ç„¡æ–™ã§ç°¡å˜ã«ã§ãã¾ã™ã­ã€‚

# å‚è€ƒè¨˜äº‹

ä»¥ä¸‹è¨˜äº‹ã‚’å‚è€ƒã«å®Ÿè£…ã‚’è¡Œã„ã¾ã—ãŸã€‚

- [Arduino ã§éŠã¼ã† -æ¸©åº¦ã‚»ãƒ³ã‚µ ICã€MCP9700 ã‚’ä½¿ã£ã¦æ¸©åº¦ã‚’æ¸¬ã‚‹](http://arms22.blog91.fc2.com/blog-entry-415.html)
- [Tornado ã‚’ä½¿ã£ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ Python ã®è¡¨ç¤ºå™¨ä»£ã‚ã‚Šã«ä½¿ã†ãƒ¡ãƒ¢ï¼ˆqiitaï¼‰](https://qiita.com/Dr10_TakeHiro/items/4b6a6e7e3cea6e62252a)
- [websocket ã‚’ä½¿ã£ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªã‚°ãƒ©ãƒ•](https://qiita.com/onsen_koichi/items/39199d60fca7ecf8964e)
